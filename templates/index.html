<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AntiGravity Strategy Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f1115;
            --bg-card: #1c1f26;
            --text-main: #f0f0f0;
            --text-dim: #8b949e;
            --accent: #238636;
            --danger: #da3633;
            --warning: #e3b341;
            --border: #30363d;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            margin-top: 0;
            font-weight: 600;
            font-size: 1.5rem;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            color: var(--text-dim);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .card-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.85;
        }

        .btn-start {
            background-color: var(--accent);
            color: white;
        }

        .btn-pause {
            background-color: var(--warning);
            color: #111;
        }

        .btn-exit {
            background-color: var(--danger);
            color: white;
        }

        .btn-close-all {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            border: 2px solid #f87171;
            animation: pulse-danger 2s infinite;
        }

        @keyframes pulse-danger {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.4);
            }

            50% {
                box-shadow: 0 0 12px 4px rgba(248, 113, 113, 0.2);
            }
        }

        .log-container {
            background-color: #0d1117;
            border: 1px solid var(--border);
            border-radius: 8px;
            height: 250px;
            overflow-y: auto;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .log-entry {
            margin-bottom: 0.25rem;
        }

        .log-time {
            color: var(--accent);
            margin-right: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background-color: rgba(35, 134, 54, 0.2);
            color: #4ade80;
        }

        .status-paused {
            background-color: rgba(227, 179, 65, 0.2);
            color: #facc15;
        }

        .status-stopped {
            background-color: rgba(139, 148, 158, 0.2);
            color: var(--text-dim);
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th,
        td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #0d1117;
            color: var(--text-dim);
            position: sticky;
            top: 0;
        }

        .win {
            color: #4ade80;
        }

        .header-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 0.45rem 1rem;
            border-radius: 6px;
            font-size: 0.82rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-logout:hover {
            border-color: var(--danger);
            color: var(--danger);
            opacity: 1;
        }

        .pos-table th,
        .pos-table td {
            padding: 0.6rem 0.9rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.84rem;
        }

        .pos-table th {
            background-color: #0d1117;
            color: var(--text-dim);
        }

        .pos-table {
            width: 100%;
            border-collapse: collapse;
        }

        .dir-buy {
            background: rgba(74, 222, 128, 0.15);
            color: #4ade80;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .dir-sell {
            background: rgba(248, 113, 113, 0.15);
            color: #f87171;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .pnl-pos {
            color: #4ade80;
            font-weight: 600;
        }

        .pnl-neg {
            color: #f87171;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-bar">
            <h1>‚ö° AntiGravity ‚Äî Live Execution Monitor</h1>
            <div style="display:flex;gap:0.75rem;align-items:center;">
                <a href="/backtest" class="btn-logout" style="border-color:#1e3c72;color:#93c5fd;">Backtest Runner ‚Üí</a>
                <a href="/logout" class="btn-logout">Sign Out ‚Üí</a>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title">Strategy Engine</div>
                <div class="card-value" id="strategy-status-text">--</div>
                <div id="status-badge-container" style="margin-top: 0.5rem;"></div>
            </div>
            <div class="card">
                <div class="card-title">Open Position</div>
                <div class="card-value" id="position-text">None</div>
            </div>
            <div class="card">
                <div class="card-title">Performance (Unrealized)</div>
                <div class="card-value" id="pnl-text">‚Çπ0.00</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">‚ñ∂ Select Strategies for LIVE Trading (Actual Money)</div>
            <table class="pos-table" id="live-strategies-table" style="margin-bottom: 1.5rem;">
                <thead>
                    <tr>
                        <th style="width: 50px;">Run?</th>
                        <th>Strategy Name</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="checkbox" class="strat-checkbox-live" value="v4_gamma"></td>
                        <td style="font-weight:600; color: #dc2626;">V4 Gamma [LIVE]</td>
                        <td style="color: var(--text-dim);">Nifty options straddle with 50% initial SL and 15% trailing
                        </td>
                    </tr>
                    <tr>
                        <td><input type="checkbox" class="strat-checkbox-live" value="gamma_blast"></td>
                        <td style="font-weight:600; color: #dc2626;">Gamma Blast [LIVE]</td>
                        <td style="color: var(--text-dim);">Aggressive gamma expansion trading based on straddle
                            momentum</td>
                    </tr>
                </tbody>
            </table>

            <div class="controls"
                style="margin-bottom: 2rem; display: flex; align-items: center; justify-content: flex-start;">
                <button class="btn-start" style="background:#dc2626; width: auto; padding: 0.6rem 1.5rem;"
                    onclick="handleAction('start', 'live')">‚ñ∂ Start LIVE Selected</button>
            </div>

            <div class="card-title" style="margin-top:2rem;">‚ñ∂ Select Strategies for FORWARD Testing (Paper Trading)
            </div>
            <table class="pos-table" id="paper-strategies-table" style="margin-bottom: 1.5rem;">
                <thead>
                    <tr>
                        <th style="width: 50px;">Run?</th>
                        <th>Strategy Name</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="checkbox" class="strat-checkbox-paper" value="v4_gamma" checked></td>
                        <td style="font-weight:600; color: #2563eb;">V4 Gamma [PAPER]</td>
                        <td style="color: var(--text-dim);">Nifty options straddle with 50% initial SL and 15% trailing
                        </td>
                    </tr>
                    <tr>
                        <td><input type="checkbox" class="strat-checkbox-paper" value="gamma_blast"></td>
                        <td style="font-weight:600; color: #2563eb;">Gamma Blast [PAPER]</td>
                        <td style="color: var(--text-dim);">Aggressive gamma expansion trading based on straddle
                            momentum</td>
                    </tr>
                </tbody>
            </table>

            <div class="controls"
                style="margin-bottom: 2rem; display: flex; align-items: center; justify-content: flex-start;">
                <button class="btn-start" style="background:#2563eb; width: auto; padding: 0.6rem 1.5rem;"
                    onclick="handleAction('start', 'paper')">‚ñ∂ Start PAPER Selected</button>
            </div>

            <div class="controls"
                style="margin-bottom: 0; display: flex; justify-content: center; gap: 0.8rem; border-top: 1px solid var(--border); padding-top: 1.5rem;">
                <span
                    style="color:var(--text-dim); align-self: center; font-size: 0.85rem; font-weight:600; margin-right: 1rem;">GLOBAL
                    CONTROLS</span>
                <button class="btn-pause" onclick="handleAction('pause')">‚è∏ Pause All BOTS</button>
                <button class="btn-pause" onclick="handleAction('resume')">‚èØ Resume All BOTS</button>
                <button class="btn-exit" onclick="handleAction('stop')">üõë STOP ALL BOTS</button>
            </div>

            <div class="card">
                <div class="card-title">System Logs</div>
                <div class="log-container" id="logs">
                    <div class="log-entry"><span class="log-time">[System]</span> UI initialized.</div>
                </div>
            </div>

            <!-- Current Positions -->
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <div class="card-title" style="margin:0;">üìå Current Open Positions</div>
                    <div style="display:flex; align-items:center; gap:0.8rem;">
                        <span id="pos-updated" style="font-size:0.75rem; color:var(--text-dim);"></span>
                        <button id="pos-refresh-btn" onclick="togglePositionRefresh()" style="padding:0.35rem 0.9rem; font-size:0.78rem; font-weight:600;
                               background: rgba(35,134,54,0.2); border:1px solid #238636;
                               color:#4ade80; border-radius:6px; cursor:pointer; transition:all 0.2s;">
                            ‚ñ∂ Live Refresh
                        </button>
                        <button onclick="confirmCloseAll()" style="padding:0.35rem 0.9rem; font-size:0.78rem; font-weight:600;
                               background: rgba(220,38,38,0.2); border:1px solid #dc2626;
                               color:#f87171; border-radius:6px; cursor:pointer; transition:all 0.2s;">
                            üíÄ Close All
                        </button>
                    </div>
                </div>
                <div class="table-container" style="max-height:260px;">
                    <table class="pos-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Script</th>
                                <th>Direction</th>
                                <th>Qty</th>
                                <th>Avg Price</th>
                                <th>LTP</th>
                                <th>Unrealized P&L</th>
                            </tr>
                        </thead>
                        <tbody id="pos-tbody">
                            <tr>
                                <td colspan="7" style="text-align:center;color:var(--text-dim);padding:1.5rem;">No open
                                    positions</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>


        </div>

        <script>
            async function fetchStatus() {
                try {
                    const res = await fetch('/api/status');
                    const data = await res.json();

                    const statusText = document.getElementById('strategy-status-text');
                    const badgeContainer = document.getElementById('status-badge-container');

                    if (!data.running) {
                        statusText.innerText = "Stopped";
                        badgeContainer.innerHTML = '<span class="status-badge status-stopped">Offline</span>';
                    } else if (data.paused) {
                        statusText.innerText = data.active_names ? data.active_names + " (Paused)" : "Paused";
                        badgeContainer.innerHTML = '<span class="status-badge status-paused">Standby</span>';
                    } else {
                        statusText.innerText = data.active_names || "Running";
                        badgeContainer.innerHTML = '<span class="status-badge status-active">Monitoring Live</span>';
                    }

                    document.getElementById('position-text').innerText = data.in_position ? "Active" : "None";

                    const uPnl = data.unrealized_pnl || 0;
                    const rPnl = data.realized_pnl || 0;
                    const totalPnl = uPnl + rPnl;

                    const pnlElement = document.getElementById('pnl-text');
                    pnlElement.innerText = `‚Çπ${totalPnl.toLocaleString()}`;
                    pnlElement.title = `Unrealized: ‚Çπ${uPnl.toLocaleString()} | Realized: ‚Çπ${rPnl.toLocaleString()}`;
                    pnlElement.style.color = totalPnl >= 0 ? '#4ade80' : '#f87171';

                } catch (err) {
                    console.error("Status fetch failed", err);
                }
            }

            async function handleAction(action, targetType = 'all') {
                try {
                    let payload = {};
                    if (action === 'start') {
                        let liveSelected = [];
                        let paperSelected = [];

                        if (targetType === 'all' || targetType === 'live') {
                            const liveBoxes = document.querySelectorAll('.strat-checkbox-live:checked');
                            liveSelected = Array.from(liveBoxes).map(cb => cb.value);
                        }

                        if (targetType === 'all' || targetType === 'paper') {
                            const paperBoxes = document.querySelectorAll('.strat-checkbox-paper:checked');
                            paperSelected = Array.from(paperBoxes).map(cb => cb.value);
                        }

                        if (liveSelected.length === 0 && paperSelected.length === 0) {
                            alert(`Please select at least one strategy to run for ${targetType.toUpperCase()} mode.`);
                            return;
                        }
                        if (liveSelected.length > 0) {
                            const confirmed = confirm("‚ö†Ô∏è WARNING: You have selected LIVE mode for some strategies! This will execute real trades on Dhan with actual money. Proceed?");
                            if (!confirmed) return;
                        }
                        payload = { live: liveSelected, paper: paperSelected };
                    }

                    const res = await fetch(`/api/${action}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: Object.keys(payload).length > 0 ? JSON.stringify(payload) : null
                    });

                    const data = await res.json();
                    addLog(data.message);
                    fetchStatus();
                } catch (err) {
                    addLog("Error executing action: " + action);
                }
            }

            function addLog(msg) {
                const logs = document.getElementById('logs');
                const time = new Date().toLocaleTimeString();
                logs.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span> ${msg}</div>`;
                logs.scrollTop = logs.scrollHeight;
            }

            function confirmCloseAll() {
                const confirmed = confirm('‚ö†Ô∏è WARNING: This will close ALL open positions at MARKET price immediately. Are you absolutely sure?');
                if (confirmed) {
                    handleAction('close_all_positions');
                } else {
                    addLog('Close All Positions cancelled by user.');
                }
            }

            async function fetchPositions() {
                try {
                    const res = await fetch('/api/positions');
                    const data = await res.json();
                    const tbody = document.getElementById('pos-tbody');
                    document.getElementById('pos-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString('en-IN');

                    if (data.status === 'success' && data.data.length > 0) {
                        tbody.innerHTML = data.data.map((p, i) => {
                            const pnl = p.unrealized_pnl;
                            const pnlCls = pnl >= 0 ? 'pnl-pos' : 'pnl-neg';
                            const pnlStr = (pnl >= 0 ? '+' : '') + '‚Çπ' + pnl.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            return `<tr>
                            <td style="color:var(--text-dim);">${i + 1}</td>
                            <td style="font-weight:600;">${p.script}</td>
                            <td><span class="dir-${p.direction.toLowerCase()}">${p.direction}</span></td>
                            <td>${p.qty}</td>
                            <td>‚Çπ${Number(p.avg_price).toLocaleString('en-IN')}</td>
                            <td>‚Çπ${Number(p.ltp).toLocaleString('en-IN')}</td>
                            <td class="${pnlCls}">${pnlStr}</td>
                        </tr>`;
                        }).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);padding:1.5rem;">No open positions</td></tr>';
                    }
                } catch (err) {
                    console.error('Positions fetch failed', err);
                }
            }

            let _posInterval = null;

            function togglePositionRefresh() {
                const btn = document.getElementById('pos-refresh-btn');
                if (_posInterval) {
                    clearInterval(_posInterval);
                    _posInterval = null;
                    btn.textContent = '‚ñ∂ Live Refresh';
                    btn.style.background = 'rgba(35,134,54,0.2)';
                    btn.style.borderColor = '#238636';
                    btn.style.color = '#4ade80';
                } else {
                    fetchPositions();
                    _posInterval = setInterval(fetchPositions, 5000);
                    btn.textContent = '‚èπ Stop Refresh';
                    btn.style.background = 'rgba(248,113,113,0.15)';
                    btn.style.borderColor = '#f87171';
                    btn.style.color = '#f87171';
                }
            }

            setInterval(fetchStatus, 2000);
            fetchStatus();
        </script>
</body>

</html>